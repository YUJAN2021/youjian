<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker API è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        h2 { color: #667eea; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        input, select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }
        button:hover { background: #5568d3; }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>ğŸ” Worker API è¯Šæ–­å·¥å…·</h1>

    <div class="card">
        <h2>é…ç½®ä¿¡æ¯</h2>
        <label>Worker URL:</label>
        <input type="text" id="workerUrl" value="https://temp-email-api.20210308.xyz" placeholder="https://your-worker.workers.dev">

        <label>API ç±»å‹:</label>
        <select id="apiType">
            <option value="admin">admin (/admin/mails)</option>
            <option value="user">user (/user_api/mails)</option>
            <option value="api">api (/api/mails)</option>
        </select>

        <label>å¯†ç :</label>
        <input type="password" id="password" value="YUJANsex." placeholder="è¾“å…¥å¯†ç ">

        <button onclick="testWorker()">æµ‹è¯• Worker API</button>

        <div id="result"></div>
    </div>

    <div class="card">
        <h2>ğŸ“ æµ‹è¯•è¯´æ˜</h2>
        <p><strong>æµ‹è¯•é¡¹ç›®ï¼š</strong></p>
        <ol>
            <li>URL æ ¼å¼æ£€æŸ¥</li>
            <li>åŸŸåè§£ææµ‹è¯•</li>
            <li>API ç«¯ç‚¹å¯ç”¨æ€§</li>
            <li>è®¤è¯æµ‹è¯•</li>
        </ol>
    </div>

    <script>
        async function testWorker() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="warning">æ­£åœ¨æµ‹è¯•...</div>';

            let workerUrl = document.getElementById('workerUrl').value.trim();
            const apiType = document.getElementById('apiType').value;
            const password = document.getElementById('password').value;

            const tests = [];

            // æµ‹è¯• 1: URL æ ¼å¼æ£€æŸ¥
            tests.push(`<h3>æµ‹è¯• 1: URL æ ¼å¼æ£€æŸ¥</h3>`);
            try {
                const url = new URL(workerUrl);
                tests.push(`âœ… URL æ ¼å¼æ­£ç¡®: ${url.href}`);

                // ç§»é™¤å°¾éƒ¨æ–œæ 
                workerUrl = workerUrl.replace(/\/+$/, '');
                tests.push(`âœ… æ ‡å‡†åŒ–åçš„ URL: ${workerUrl}`);
            } catch (e) {
                tests.push(`âŒ URL æ ¼å¼é”™è¯¯: ${e.message}`);
                resultDiv.innerHTML = `<div class="error">${tests.join('<br>')}</div>`;
                return;
            }

            // æµ‹è¯• 2: æ„å»º API URL
            tests.push(`<h3>æµ‹è¯• 2: API ç«¯ç‚¹</h3>`);
            let apiEndpoint;
            let headers = {};

            if (apiType === 'admin') {
                apiEndpoint = `${workerUrl}/admin/mails?limit=5`;
                headers['x-admin-auth'] = password;
                tests.push(`âœ… API ç«¯ç‚¹: ${apiEndpoint}`);
                tests.push(`âœ… è®¤è¯æ–¹å¼: x-admin-auth`);
            } else if (apiType === 'user') {
                apiEndpoint = `${workerUrl}/user_api/mails?limit=5`;
                headers['x-admin-auth'] = password;
                tests.push(`âœ… API ç«¯ç‚¹: ${apiEndpoint}`);
                tests.push(`âœ… è®¤è¯æ–¹å¼: x-admin-auth`);
            } else {
                apiEndpoint = `${workerUrl}/api/mails?limit=5`;
                headers['Authorization'] = `Bearer ${password}`;
                tests.push(`âœ… API ç«¯ç‚¹: ${apiEndpoint}`);
                tests.push(`âœ… è®¤è¯æ–¹å¼: Bearer Token`);
            }

            // æµ‹è¯• 3: æ— è®¤è¯è¯·æ±‚ï¼ˆæµ‹è¯•ç«¯ç‚¹æ˜¯å¦å­˜åœ¨ï¼‰
            tests.push(`<h3>æµ‹è¯• 3: ç«¯ç‚¹å¯ç”¨æ€§æµ‹è¯•ï¼ˆæ— è®¤è¯ï¼‰</h3>`);
            try {
                const response = await fetch(apiEndpoint);
                tests.push(`âœ… HTTP çŠ¶æ€ç : ${response.status}`);

                if (response.status === 401 || response.status === 403) {
                    tests.push(`âœ… ç«¯ç‚¹å­˜åœ¨ï¼è¿”å› ${response.status} è¯´æ˜éœ€è¦è®¤è¯ï¼ˆæ­£å¸¸ï¼‰`);
                } else if (response.status === 404) {
                    tests.push(`âŒ 404 é”™è¯¯ï¼šç«¯ç‚¹ä¸å­˜åœ¨ï¼`);
                    tests.push(`âš ï¸ è¯·æ£€æŸ¥ï¼š`);
                    tests.push(`   1. Worker URL æ˜¯å¦æ­£ç¡®`);
                    tests.push(`   2. API ç±»å‹æ˜¯å¦é€‰å¯¹`);
                    tests.push(`   3. Worker æ˜¯å¦æ­£ç¡®éƒ¨ç½²`);
                } else if (response.status === 200) {
                    tests.push(`âœ… ç«¯ç‚¹å¯è®¿é—®ä¸”ä¸éœ€è¦è®¤è¯ï¼`);
                }

                const text = await response.text();
                if (text) {
                    tests.push(`ğŸ“„ å“åº”å†…å®¹: <pre>${text.substring(0, 200)}${text.length > 200 ? '...' : ''}</pre>`);
                }
            } catch (e) {
                tests.push(`âŒ è¯·æ±‚å¤±è´¥: ${e.message}`);
                tests.push(`âš ï¸ å¯èƒ½åŸå› ï¼š`);
                tests.push(`   1. Worker URL é”™è¯¯`);
                tests.push(`   2. ç½‘ç»œè¿æ¥é—®é¢˜`);
                tests.push(`   3. CORS é™åˆ¶`);
                resultDiv.innerHTML = `<div class="error">${tests.join('<br>')}</div>`;
                return;
            }

            // æµ‹è¯• 4: å¸¦è®¤è¯è¯·æ±‚
            tests.push(`<h3>æµ‹è¯• 4: è®¤è¯æµ‹è¯•</h3>`);
            try {
                const response = await fetch(apiEndpoint, { headers });
                tests.push(`âœ… HTTP çŠ¶æ€ç : ${response.status}`);

                if (response.ok) {
                    tests.push(`âœ… è®¤è¯æˆåŠŸï¼`);
                    const data = await response.json();
                    tests.push(`ğŸ“§ é‚®ä»¶æ•°é‡: ${data.results?.length || data.data?.length || 0}`);
                    tests.push(`ğŸ“„ å“åº”æ•°æ®: <pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>`);
                } else if (response.status === 401 || response.status === 403) {
                    tests.push(`âŒ è®¤è¯å¤±è´¥ï¼šå¯†ç é”™è¯¯`);
                    tests.push(`âš ï¸ è¯·æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®`);
                } else {
                    tests.push(`âŒ è¯·æ±‚å¤±è´¥: ${response.status}`);
                }
            } catch (e) {
                tests.push(`âŒ è®¤è¯è¯·æ±‚å¤±è´¥: ${e.message}`);
            }

            // æ˜¾ç¤ºç»“æœ
            const allSuccess = !tests.join('').includes('âŒ');
            const className = allSuccess ? 'success' : (tests.join('').includes('âœ…') ? 'warning' : 'error');
            resultDiv.innerHTML = `<div class="result ${className}">${tests.join('<br>')}</div>`;
        }
    </script>
</body>
</html>
